name: Auto Domain Labeler

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write

jobs:
  auto-label-domain:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - name: Detect and Add Domain Labels
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get issue text (title + body)
            const text = (issue.title + ' ' + (issue.body || '')).toLowerCase();

            // Current labels
            const currentLabels = issue.labels.map(function(l) { return l.name.toLowerCase(); });

            // Domain label definitions with keywords
            // Requires 2+ keyword matches to add label (prevents false positives)
            const domainConfig = {
              'frontend': {
                keywords: ['react', 'ui', 'css', 'html', 'tailwind', 'component', 'button', 'page', 'layout', 'style', 'responsive', 'navbar', 'sidebar', 'modal', 'form'],
                minMatches: 2
              },
              'backend': {
                keywords: ['api', 'server', 'database', 'sql', 'endpoint', 'route', 'fastapi', 'flask', 'django', 'express', 'mongodb', 'postgres', 'mysql', 'rest', 'graphql'],
                minMatches: 2
              },
              'mobile': {
                keywords: ['android', 'ios', 'react native', 'flutter', 'mobile', 'app store', 'play store', 'swift', 'kotlin', 'expo'],
                minMatches: 2
              },
              'desktop': {
                keywords: ['electron', 'tkinter', 'pyqt', 'gui', 'desktop', 'window', 'native', 'installer', 'exe', 'dmg'],
                minMatches: 2
              },
              'cli': {
                keywords: ['cli', 'command line', 'terminal', 'argparse', 'script', 'bash', 'powershell', 'shell', 'console'],
                minMatches: 2
              },
              'ml': {
                keywords: ['machine learning', 'model', 'train', 'predict', 'tensorflow', 'pytorch', 'sklearn', 'neural', 'dataset', 'ai', 'classification', 'regression'],
                minMatches: 2
              },
              'documentation': {
                keywords: ['documentation', 'readme', 'docs', 'guide', 'tutorial', 'wiki', 'markdown', 'contributing', 'changelog'],
                minMatches: 2
              },
              'testing': {
                keywords: ['test', 'unittest', 'pytest', 'jest', 'coverage', 'ci', 'integration test', 'e2e', 'mock'],
                minMatches: 2
              },
              'devops': {
                keywords: ['docker', 'kubernetes', 'ci/cd', 'github actions', 'workflow', 'deploy', 'nginx', 'aws', 'azure', 'gcp'],
                minMatches: 2
              }
            };

            const labelsToAdd = [];

            for (const [domain, config] of Object.entries(domainConfig)) {
              // Skip if label already exists
              if (currentLabels.includes(domain)) {
                console.log('Label already exists: ' + domain);
                continue;
              }
              
              // Count keyword matches
              let matchCount = 0;
              for (const keyword of config.keywords) {
                if (text.includes(keyword)) {
                  matchCount++;
                }
              }
              
              // Add label if enough matches
              if (matchCount >= config.minMatches) {
                labelsToAdd.push(domain);
                console.log('Detected domain: ' + domain + ' (' + matchCount + ' matches)');
              }
            }

            // Add detected labels
            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner, repo,
                issue_number: issue.number,
                labels: labelsToAdd
              });
              console.log('Added labels: ' + labelsToAdd.join(', '));
              
              // Add a comment explaining the auto-labels
              await github.rest.issues.createComment({
                owner, repo,
                issue_number: issue.number,
                body: 'ğŸ·ï¸ **Auto-detected domain labels:** ' + labelsToAdd.map(function(l) { return '`' + l + '`'; }).join(', ') + '\n\n_These labels were added based on keywords in your issue. Maintainers may adjust them if needed._'
              });
            } else {
              console.log('No domain labels detected (insufficient keyword matches)');
            }
