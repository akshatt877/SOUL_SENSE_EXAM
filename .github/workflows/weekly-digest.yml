name: Weekly Community Digest

on:
  schedule:
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  create-weekly-digest:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Weekly Digest
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const weekAgoISO = weekAgo.toISOString();

            const formatDate = function(d) { return d.toISOString().split('T')[0]; };
            const startDate = formatDate(weekAgo);
            const endDate = formatDate(now);

            const newIssues = await github.rest.issues.listForRepo({
              owner, repo,
              state: 'all',
              since: weekAgoISO,
              per_page: 100
            });

            const issuesThisWeek = newIssues.data.filter(function(i) {
              return !i.pull_request && new Date(i.created_at) >= weekAgo;
            });

            const closedThisWeek = newIssues.data.filter(function(i) {
              return !i.pull_request && i.state === 'closed' && i.closed_at && new Date(i.closed_at) >= weekAgo;
            });

            const prs = await github.rest.pulls.list({
              owner, repo,
              state: 'all',
              sort: 'updated',
              direction: 'desc',
              per_page: 100
            });

            const prsThisWeek = prs.data.filter(function(p) {
              return new Date(p.created_at) >= weekAgo;
            });

            const mergedThisWeek = prs.data.filter(function(p) {
              return p.merged_at && new Date(p.merged_at) >= weekAgo;
            });

            const contributors = new Set();
            issuesThisWeek.forEach(function(i) { contributors.add(i.user.login); });
            prsThisWeek.forEach(function(p) { contributors.add(p.user.login); });

            const prCountByAuthor = {};
            mergedThisWeek.forEach(function(p) {
              prCountByAuthor[p.user.login] = (prCountByAuthor[p.user.login] || 0) + 1;
            });

            const topContributors = Object.entries(prCountByAuthor)
              .sort(function(a, b) { return b[1] - a[1]; })
              .slice(0, 5);

            let topContribList = '';
            if (topContributors.length > 0) {
              topContribList = topContributors.map(function(item, i) {
                return (i + 1) + '. @' + item[0] + ' - ' + item[1] + ' PRs merged';
              }).join('\n');
            } else {
              topContribList = '_No merged PRs this week_';
            }

            let closedList = '';
            if (closedThisWeek.length > 0) {
              closedList = closedThisWeek.slice(0, 10).map(function(i) {
                return '- #' + i.number + ': ' + i.title;
              }).join('\n');
            } else {
              closedList = '_No issues closed this week_';
            }

            let mergedList = '';
            if (mergedThisWeek.length > 0) {
              mergedList = mergedThisWeek.slice(0, 10).map(function(p) {
                return '- #' + p.number + ': ' + p.title + ' by @' + p.user.login;
              }).join('\n');
            } else {
              mergedList = '_No PRs merged this week_';
            }

            const digestBody = '# Weekly Community Digest\n\n' +
              '**Week of ' + startDate + ' to ' + endDate + '**\n\n' +
              '---\n\n' +
              '## This Weeks Stats\n\n' +
              '| Metric | Count |\n' +
              '|--------|-------|\n' +
              '| New Issues | ' + issuesThisWeek.length + ' |\n' +
              '| Issues Closed | ' + closedThisWeek.length + ' |\n' +
              '| PRs Opened | ' + prsThisWeek.length + ' |\n' +
              '| PRs Merged | ' + mergedThisWeek.length + ' |\n' +
              '| Active Contributors | ' + contributors.size + ' |\n\n' +
              '---\n\n' +
              '## Top Contributors This Week\n' + topContribList + '\n\n' +
              '---\n\n' +
              '## Issues Closed This Week\n' + closedList + '\n\n' +
              '---\n\n' +
              '## PRs Merged This Week\n' + mergedList + '\n\n' +
              '---\n\n' +
              '## Looking Ahead\n\n' +
              'Check out [issues needing help](https://github.com/' + owner + '/' + repo + '/issues?q=is%3Aopen+label%3A%22help+wanted%22) or [good first issues](https://github.com/' + owner + '/' + repo + '/issues?q=is%3Aopen+label%3A%22good+first+issue%22) to get involved!\n\n' +
              '---\n\n' +
              '_This digest was generated automatically. See you next week!_';

            const digestIssue = await github.rest.issues.create({
              owner, repo,
              title: 'Weekly Digest: ' + startDate + ' to ' + endDate,
              body: digestBody,
              labels: ['digest', 'automated', 'documentation']
            });

            console.log('Weekly digest created: #' + digestIssue.data.number);

            const oldDigests = await github.rest.issues.listForRepo({
              owner, repo,
              labels: 'digest,automated',
              state: 'open',
              per_page: 10
            });

            for (const oldDigest of oldDigests.data) {
              if (oldDigest.number !== digestIssue.data.number) {
                await github.rest.issues.update({
                  owner, repo,
                  issue_number: oldDigest.number,
                  state: 'closed'
                });
                console.log('Closed old digest: #' + oldDigest.number);
              }
            }
