name: Unassign inactive contributors

on:
  schedule:
    - cron: "0 * * * *"

permissions:
  issues: write

jobs:
  unassign-inactive:
    runs-on: ubuntu-latest

    steps:
      - name: Check and warn inactive contributors
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date();

            const WARNING_AFTER_HOURS = 15;
            const UNASSIGN_AFTER_HOURS = 30;

            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: "open",
                per_page: 100,
              }
            );

            for (const issue of issues) {
              if (issue.pull_request) continue;
              if (!issue.assignees || issue.assignees.length === 0) continue;

              const lastUpdated = new Date(issue.updated_at);
              const diffHours = (now - lastUpdated) / (1000 * 60 * 60);

              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
              });

              const warningComment = comments.data.find(function(c) {
                return c.body.includes("Inactivity Warning");
              });

              const assigneesMention = issue.assignees
                .map(function(a) { return '@' + a.login; })
                .join(", ");

              if (diffHours >= WARNING_AFTER_HOURS && !warningComment) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: '⚠️ **Inactivity Warning**\n\n' +
                    assigneesMention + ', this issue has been inactive for **15 hours**.\n\n' +
                    'Please provide an update within the next **15 hours**, or you may be **automatically unassigned**.'
                });

                console.log('Warning sent for issue #' + issue.number);
                continue;
              }

              if (diffHours >= UNASSIGN_AFTER_HOURS && warningComment) {
                const assigneeLogins = issue.assignees.map(function(a) { return a.login; });

                await github.rest.issues.removeAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  assignees: assigneeLogins,
                });

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: 'ℹ️ **Unassigned due to inactivity**\n\n' +
                    'You have been automatically unassigned after **30 hours of inactivity**.\n' +
                    'Feel free to reassign yourself if you wish to continue working on this issue.'
                });

                console.log('Unassigned contributors from issue #' + issue.number);
              }
            }
